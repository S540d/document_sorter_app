<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Sorter MVP</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            padding: 20px 20px 40px 20px; /* Extra bottom padding for footer */
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" patternUnits="userSpaceOnUse" width="100" height="100"><rect width="100" height="100" fill="%23ffffff" opacity="0.03"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            pointer-events: none;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 280px 1fr 1fr;
            gap: 0;
            min-height: 600px;
        }
        
        .sidebar {
            background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 30px;
            border-right: 1px solid #dee2e6;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }

        .intelligent-column {
            background: linear-gradient(180deg, #f0f8ff 0%, #e6f3ff 100%);
            padding: 25px;
            border-right: 1px solid #dee2e6;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }

        .manual-column {
            background: linear-gradient(180deg, #fff8f0 0%, #ffeee6 100%);
            padding: 25px;
        }

        .column-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(0, 0, 0, 0.1);
            font-weight: bold;
            font-size: 1.1rem;
        }

        .intelligent-column .column-header {
            color: #1976d2;
        }

        .manual-column .column-header {
            color: #f57c00;
        }
        
        .file-list {
            margin-bottom: 30px;
        }
        
        .file-item {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .file-item:hover {
            border-color: #667eea;
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
            background: linear-gradient(145deg, #ffffff 0%, #f0f4ff 100%);
        }
        
        .file-item.active {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .file-name {
            font-weight: bold;
            margin-bottom: 5px;
            word-break: break-all;
        }
        
        .file-meta {
            font-size: 0.85rem;
            color: #666;
        }
        
        .refresh-btn, .random-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-size: 1rem;
            margin-bottom: 10px;
        }
        
        .refresh-btn:hover, .random-btn:hover {
            background: #5a6fd8;
        }
        
        .random-btn {
            background: #38a169;
            margin-bottom: 20px;
        }
        
        .random-btn:hover {
            background: #2f855a;
        }
        
        .document-view {
            padding: 30px;
            display: flex;
            flex-direction: column;
        }
        
        .loading {
            text-align: center;
            color: #666;
            font-size: 1.2rem;
            margin: 50px 0;
        }
        
        .document-preview {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 30px;
            margin-bottom: 30px;
            position: sticky;
            top: 20px;
            z-index: 10;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .preview-image {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .classification-panel {
            background: linear-gradient(145deg, #f8f9fa 0%, #ffffff 100%);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #e9ecef;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .classification-panel h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .category-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .path-browser {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            margin-bottom: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .path-browser.collapsed {
            max-height: 40px;
            overflow: hidden;
        }

        .path-browser-header {
            background: #e9ecef;
            padding: 10px;
            font-weight: bold;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .path-browser-header:hover {
            background: #dee2e6;
        }

        .collapse-icon {
            transition: transform 0.2s;
        }

        .collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .directory-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(233, 236, 239, 0.5);
            transition: all 0.3s ease;
            border-radius: 6px;
            margin: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .directory-item .expand-icon {
            font-size: 12px;
            transition: transform 0.2s;
            color: #6c757d;
            width: 12px;
        }

        .directory-item.expanded .expand-icon {
            transform: rotate(90deg);
        }

        .directory-item.no-children .expand-icon {
            opacity: 0;
        }

        .directory-item:hover {
            background: linear-gradient(135deg, #e8f4fd 0%, #d1ecf1 100%);
            transform: translateX(3px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .directory-item.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transform: translateX(5px);
        }

        .directory-item.selected .expand-icon {
            color: white;
        }

        .directory-level-0 { padding-left: 15px; }
        .directory-level-1 { padding-left: 35px; display: none; }
        .directory-level-2 { padding-left: 55px; display: none; }
        .directory-level-3 { padding-left: 75px; display: none; }
        .directory-level-4 { padding-left: 95px; display: none; }

        .directory-item.show { display: flex !important; }

        .preloaded-indicator {
            background: #d4edda;
            color: #155724;
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 5px;
        }

        .suggested-category-badge {
            background: #fff3cd;
            color: #856404;
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 5px;
        }

        .custom-path-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .global-search-container, .suggested-path-container {
            position: relative;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(145deg, #e8f4fd 0%, #d1ecf1 100%);
            border-radius: 8px;
            border: 1px solid #b8e6f0;
        }

        .global-search-container label, .suggested-path-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c5282;
        }

        .path-search-container {
            position: relative;
            margin-bottom: 15px;
        }

        .path-search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        #suggested-path-input {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            color: #495057;
            font-family: monospace;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: #f8f9fa;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .smart-suggestion {
            background: linear-gradient(145deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #f4d03f;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .smart-suggestion:hover {
            background: linear-gradient(145deg, #ffeaa7 0%, #f4d03f 100%);
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(244, 208, 63, 0.3);
        }

        .suggestion-path {
            font-family: monospace;
            font-size: 0.9rem;
            color: #333;
            margin-bottom: 4px;
        }

        .suggestion-score {
            font-size: 0.8rem;
            color: #666;
        }

        .system-status {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .system-status h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9rem;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }

        .status-value {
            font-weight: bold;
        }

        .status-warning {
            color: #dc3545;
            font-weight: bold;
        }

        .status-good {
            color: #28a745;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 5px 0;
        }

        .progress-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.8rem;
            text-align: center;
            line-height: 20px;
            color: white;
            position: absolute;
            width: 100%;
        }

        .tagging-status {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9rem;
        }
        
        .suggested-path {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-family: monospace;
            font-size: 0.9rem;
            word-break: break-all;
        }

        .filename-info-section {
            background: #f8f9ff;
            border: 1px solid #e0e6ff;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .filename-info-section h4 {
            margin: 0 0 10px 0;
            color: #4a5568;
        }

        .filename-details {
            font-size: 0.9rem;
        }

        .filename-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filename-row strong {
            min-width: 120px;
            color: #2d3748;
        }

        .filename-original {
            font-family: monospace;
            background: #fff2f2;
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid #fed7d7;
        }

        .filename-suggested {
            font-family: monospace;
            background: #f0fff4;
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid #c6f6d5;
            font-weight: bold;
        }

        .filename-dates {
            font-family: monospace;
            background: #f7fafc;
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid #e2e8f0;
        }

        .filename-selected-date {
            font-family: monospace;
            background: #fff5b4;
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid #f6e05e;
            font-weight: bold;
        }

        .date-source-badge {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        /* New Workflow Design */
        .processing-workflow {
            display: flex;
            flex-direction: column;
            gap: 25px;
            margin-bottom: 20px;
        }

        .workflow-step {
            background: linear-gradient(135deg, #f8faff 0%, #f0f4ff 100%);
            border: 2px solid #e8eeff;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
        }

        .workflow-step:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
            border-color: #d0deff;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e8eeff;
        }

        .step-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .step-header h3 {
            margin: 0;
            color: #4a5568;
            font-size: 1.3rem;
            flex: 1;
        }

        .filename-mode-toggle {
            display: flex;
            gap: 15px;
            background: white;
            padding: 8px;
            border-radius: 25px;
            border: 2px solid #e8eeff;
            flex-wrap: wrap;
        }

        .filename-mode-toggle input[type="radio"] {
            display: none;
        }

        .filename-mode-toggle label {
            padding: 8px 20px;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            background: transparent;
            color: #666;
        }

        .filename-mode-toggle input[type="radio"]:checked + label {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .path-selection-section, .filename-configuration {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .suggested-path-display, .current-filename, .smart-filename-section, .date-filename-section {
            background: white;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #e8eeff;
        }

        .path-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .path-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e8eeff;
            border-radius: 8px;
            font-family: monospace;
            background: #f8faff;
            color: #4a5568;
            font-size: 0.9rem;
        }

        .path-input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-icon {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-icon:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .path-customization {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .category-selection, .global-search-container {
            background: white;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #e8eeff;
        }

        .category-select, .path-search-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e8eeff;
            border-radius: 8px;
            font-size: 0.95rem;
            margin-top: 8px;
        }

        .category-select:focus, .path-search-input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .ai-suggestions-display {
            background: linear-gradient(135deg, #f0f4ff 0%, #e8eeff 100%);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #d0d9ff;
            margin-bottom: 15px;
        }

        .ai-suggestions-display label {
            font-weight: bold;
            color: #667eea;
            display: block;
            margin-bottom: 10px;
        }

        .ai-suggestion-chips {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .ai-chip {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            border: 2px solid;
        }

        .category-chip {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .subdirectory-chip {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-color: #28a745;
        }

        .filename-display {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            border-radius: 8px;
            margin-top: 8px;
        }

        .filename-display.original {
            background: #fff5f5;
            border: 2px solid #fed7d7;
        }

        .filename-display.smart {
            background: #f0fff4;
            border: 2px solid #c6f6d5;
        }

        .filename-text {
            flex: 1;
            font-family: monospace;
            font-weight: 500;
            color: #2d3748;
        }

        .filename-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e8eeff;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .detail-label {
            font-weight: 500;
            color: #4a5568;
        }

        .detail-value {
            font-family: monospace;
            background: #f7fafc;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .final-summary {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e8eeff;
            margin-bottom: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px 0;
        }

        .summary-row:not(:last-child) {
            border-bottom: 1px solid #f1f5f9;
        }

        .summary-label {
            font-weight: 600;
            color: #4a5568;
        }

        .summary-value {
            font-family: monospace;
            background: #f8faff;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            max-width: 60%;
            word-break: break-all;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            position: relative;
            overflow: hidden;
        }

        .btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .btn:hover:before {
            left: 100%;
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
        }

        .preview-container {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .preview-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            .path-customization {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .summary-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .summary-value {
                max-width: 100%;
            }
        }

        .btn-undo {
            background: #ffc107;
            color: #212529;
        }

        .btn-undo:hover {
            background: #e0a800;
        }

        .btn-undo:disabled {
            background: #6c757d;
            color: #adb5bd;
            cursor: not-allowed;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #28a745;
            color: white;
        }
        
        .btn-primary:hover {
            background: #218838;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .suggested-path-section-top {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #2196F3;
            border-radius: 12px;
            background: linear-gradient(135deg, #f3f9ff 0%, #e8f4f8 100%);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.15);
        }

        .suggested-path-section-top h4 {
            margin: 0 0 15px 0;
            color: #2196F3;
            font-weight: bold;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .suggested-path-input-top {
            width: 100%;
            padding: 15px;
            border: 1px solid #2196F3;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            background-color: #ffffff;
            color: #333;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
        }

        .ai-indicator {
            font-size: 0.9rem;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ai-indicator.ai-powered {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .ai-indicator.fallback {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);
        }

        /* Compact Filename Configuration */
        .filename-configuration.compact {
            padding: 15px 0;
        }

        .filename-options {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
        }

        .filename-option {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .filename-option:hover {
            border-color: #2196F3;
            background: #f8f9ff;
        }

        .filename-option input[type="radio"] {
            display: none;
        }

        .filename-option input[type="radio"]:checked + label {
            color: #2196F3;
        }

        .filename-option input[type="radio"]:checked {
            background: #2196F3;
        }

        .filename-option.selected {
            border-color: #2196F3;
            background: #f0f8ff;
        }

        .filename-option label {
            cursor: pointer;
            display: block;
            margin: 0;
        }

        .filename-option strong {
            display: block;
            margin-bottom: 4px;
            font-size: 0.9rem;
        }

        .filename-preview {
            font-family: monospace;
            font-size: 0.85rem;
            color: #666;
            background: #f5f5f5;
            padding: 4px 8px;
            border-radius: 4px;
            margin-top: 4px;
            word-break: break-all;
        }

        .option-badge {
            display: inline-block;
            background: #e3f2fd;
            color: #1976d2;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-top: 4px;
            font-weight: 500;
        }

        /* Intelligent Details Section */
        .intelligent-details {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-top: 15px;
        }

        .details-header {
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .details-header:hover {
            background: #e9ecef;
        }

        .toggle-icon {
            transition: transform 0.2s ease;
        }

        .toggle-icon.rotated {
            transform: rotate(180deg);
        }

        .details-content {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .detail-icon {
            font-size: 1rem;
            width: 20px;
        }

        .detail-label {
            font-weight: 500;
            color: #555;
            min-width: 120px;
        }

        .detail-value {
            color: #333;
            flex: 1;
        }

        .clickable-value, .clickable-date {
            cursor: pointer;
            color: #2196F3;
            text-decoration: underline;
            font-weight: 500;
        }

        .clickable-value:hover, .clickable-date:hover {
            color: #1976D2;
            background: rgba(33, 150, 243, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
        }

        /* New Workflow Styles */
        .ai-analysis, .manual-workflow {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .ai-header, .manual-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .ai-confidence {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .ai-confidence.high {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .ai-confidence.medium {
            background: #fff3e0;
            color: #f57c00;
        }

        .result-section {
            margin-bottom: 20px;
        }

        .result-section h4 {
            margin: 0 0 10px 0;
            font-size: 0.9rem;
            color: #555;
        }

        .category-suggestion, .filename-suggestion {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-suggestion:hover, .filename-suggestion:hover {
            border-color: #2196F3;
            background: #f8f9ff;
        }

        .category-name, .filename-name {
            font-weight: 500;
            color: #333;
        }

        .select-btn {
            background: #2196F3;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .analysis-details {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .analysis-details h4 {
            margin: 0 0 12px 0;
            font-size: 0.9rem;
            color: #555;
        }

        .detail-group {
            margin-bottom: 10px;
        }

        .detail-label {
            font-weight: 500;
            color: #666;
            font-size: 0.85rem;
            display: block;
            margin-bottom: 4px;
        }

        .clickable-items {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .clickable-item {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .clickable-item:hover {
            background: #1976d2;
            color: white;
        }

        .preview-section {
            margin-bottom: 20px;
        }

        .preview-section h4 {
            margin: 0 0 10px 0;
            font-size: 0.9rem;
            color: #555;
        }

        .preview-container {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            max-height: 300px;
        }

        .preview-image {
            width: 100%;
            height: auto;
            display: block;
        }

        .ai-action, .manual-actions {
            margin-top: auto;
            padding-top: 20px;
        }

        .btn-ai-primary {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s ease;
        }

        .btn-ai-primary:hover {
            background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
            transform: translateY(-2px);
        }

        .btn-manual-primary {
            background: linear-gradient(135deg, #f57c00 0%, #ef6c00 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s ease;
        }

        .btn-manual-primary:hover {
            background: linear-gradient(135deg, #ef6c00 0%, #e65100 100%);
            transform: translateY(-2px);
        }

        .category-dropdown, .path-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .filename-option-simple {
            margin-bottom: 8px;
        }

        .filename-option-simple label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.2s ease;
        }

        .filename-option-simple label:hover {
            background: #f5f5f5;
        }

        .filename-option-simple input[type="radio"] {
            margin: 0;
        }

        .suggested-path-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #2196F3;
            border-radius: 8px;
            background-color: #f3f9ff;
        }

        .suggested-path-section h4 {
            margin-top: 0;
            color: #2196F3;
            font-weight: bold;
        }

        .suggested-path-display {
            font-family: monospace;
            background-color: #e8f4f8;
            padding: 10px;
            border-radius: 4px;
            word-break: break-all;
            font-size: 13px;
            border-left: 4px solid #2196F3;
        }

        .system-metrics-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 15px;
            font-size: 11px;
            font-family: monospace;
            display: flex;
            justify-content: space-between;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .system-metrics-footer .metric {
            margin-right: 20px;
        }

        .system-metrics-footer .metric:last-child {
            margin-right: 0;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .document-preview {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÑ Document Sorter</h1>
            <p>KI-gest√ºtzte Dokumentensortierung mit DeepSeek R3</p>
            <div style="margin-top: 20px;">
                <a href="/path-management" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 25px; text-decoration: none; transition: all 0.3s ease; margin: 0 10px;">
                    üîó Pfad-Management
                </a>
                <a href="/math" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 25px; text-decoration: none; transition: all 0.3s ease; margin: 0 10px;">
                    üåü Kleines 1x1 Lernen
                </a>
            </div>
        </div>
        
        <div class="main-content">
            <div class="sidebar">
                <button class="refresh-btn" onclick="loadFiles()">üìÅ Dateien aktualisieren</button>
                <button class="random-btn" onclick="selectRandomDocument()">üé≤ Zuf√§lliges Dokument</button>

                <div class="file-list">
                    <h3>Zu sortierende PDFs:</h3>
                    <div id="file-list-container">
                        <div class="loading">Lade Dateien...</div>
                    </div>
                </div>
            </div>
            
            <div class="intelligent-column">
                <div class="column-header">
                    <span>ü§ñ</span>
                    <span>Intelligent</span>
                </div>
                <div id="status-container"></div>
                <div id="intelligent-content">
                    <div class="loading">W√§hlen Sie eine Datei aus der Liste</div>
                </div>
            </div>

            <div class="manual-column">
                <div class="column-header">
                    <span>üë§</span>
                    <span>Manuell</span>
                </div>
                <div id="manual-content">
                    <div class="loading">W√§hlen Sie eine Datei aus der Liste</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentDocument = null;
        let lastAction = null;
        let allDirectories = [];
        let globalDirectories = [];
        let directoryStructure = {};
        window.appCategories = [];
        
        // Dateien aus Scan-Verzeichnis laden
        async function loadFiles() {
            try {
                const response = await fetch('/api/scan-files');
                const data = await response.json();
                
                const container = document.getElementById('file-list-container');
                
                if (data.files && data.files.length > 0) {
                    container.innerHTML = data.files.map(file => `
                        <div class="file-item" onclick="selectFile('${file.path}', '${file.name}')">
                            <div class="file-name">
                                ${file.name}
                                ${file.preloaded ? '<span class="preloaded-indicator">‚ö° Geladen</span>' : ''}
                                ${file.suggested_category ? `<span class="suggested-category-badge">${file.suggested_category}</span>` : ''}
                            </div>
                            <div class="file-meta">
                                ${(file.size / 1024).toFixed(1)} KB<br>
                                ${new Date(file.modified).toLocaleString('de-DE')}
                            </div>
                        </div>
                    `).join('');

                    // System-Status aktualisieren
                    updateSystemStatus(data.system_stats, data.preload_status, data.cached_count, data.files.length);
                } else {
                    container.innerHTML = '<div class="loading">Keine PDF-Dateien gefunden</div>';
                }
            } catch (error) {
                console.error('Error loading files:', error);
                document.getElementById('file-list-container').innerHTML = 
                    '<div class="loading">Fehler beim Laden der Dateien</div>';
            }
        }
        
        // Datei ausw√§hlen und verarbeiten
        async function selectFile(path, name) {
            // UI-Update: Aktive Datei markieren
            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.file-item').classList.add('active');

            // Loading-Anzeige
            document.getElementById('intelligent-content').innerHTML =
                '<div class="loading">Verarbeite Dokument...</div>';
            document.getElementById('manual-content').innerHTML =
                '<div class="loading">Verarbeite Dokument...</div>';

            try {
                console.log('Processing document:', path);
                const response = await fetch('/api/process-document', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ path: path })
                });

                console.log('Response status:', response.status, response.statusText);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error:', errorText);
                    showStatus(`API Fehler (${response.status}): ${errorText}`, 'error');
                    return;
                }

                const data = await response.json();
                console.log('API Response data:', data);

                if (data && data.preview) {
                    currentDocument = data;
                    console.log('Calling displayNewWorkflow with:', data, name);
                    displayNewWorkflow(data, name);
                } else {
                    console.error('Invalid response data:', data);
                    showStatus('Ung√ºltige API-Antwort: Fehlende Daten', 'error');
                }
            } catch (error) {
                console.error('Error processing document:', error);
                showStatus(`Fehler bei der Dokumentenverarbeitung: ${error.message}`, 'error');
            }
        }

        // New 3-column workflow display
        function displayNewWorkflow(data, filename) {
            try {
                console.log('displayNewWorkflow called with:', data, filename);

                if (!data || !data.preview) {
                    console.error('Missing required data fields:', data);
                    showStatus('Fehler: Unvollst√§ndige Dokumentdaten', 'error');
                    return;
                }

                if (!window.appCategories || window.appCategories.length === 0) {
                    console.error('Categories not loaded yet');
                    showStatus('Fehler: Kategorien nicht geladen', 'error');
                    return;
                }

                const suggestedCategory = data.suggested_category || window.appCategories[0];
                console.log('Using suggested category:', suggestedCategory);

                // Create Intelligent Column Content
                const intelligentContent = createIntelligentContent(data, filename);
                document.getElementById('intelligent-content').innerHTML = intelligentContent;

                // Create Manual Column Content
                const manualContent = createManualContent(data, filename, suggestedCategory);
                document.getElementById('manual-content').innerHTML = manualContent;

                // Set AI indicator based on confidence
                setAIIndicator(data);

                // Setup event listeners
                setupNewWorkflowEvents();

                console.log('displayNewWorkflow completed successfully');
            } catch (error) {
                console.error('Error in displayNewWorkflow:', error);
                showStatus(`Fehler beim Anzeigen des Dokuments: ${error.message}`, 'error');
            }
        }

        function createIntelligentContent(data, filename) {
            return `
                <div class="ai-analysis">
                    <div class="ai-header">
                        <h3>üß† KI-Analyse</h3>
                        <div class="ai-confidence ${data.confidence === 'high' ? 'high' : 'medium'}">
                            ${data.confidence === 'high' ? '‚úÖ Hohe Sicherheit' : '‚ö†Ô∏è Mittlere Sicherheit'}
                        </div>
                    </div>

                    <div class="ai-results">
                        <div class="result-section">
                            <h4>üìÇ Vorgeschlagene Kategorie</h4>
                            <div class="category-suggestion" onclick="selectAICategory('${data.suggested_category}')">
                                <span class="category-name">${data.suggested_category}</span>
                                <span class="select-btn">‚úì √úbernehmen</span>
                            </div>
                        </div>

                        ${data.filename_suggestion ? `
                        <div class="result-section">
                            <h4>üìÑ Vorgeschlagener Dateiname</h4>
                            <div class="filename-suggestion" onclick="selectAIFilename()">
                                <span class="filename-name">${data.filename_suggestion.suggested_filename}</span>
                                <span class="select-btn">‚úì √úbernehmen</span>
                            </div>
                        </div>

                        <div class="analysis-details">
                            <h4>üîç Gefundene Details</h4>
                            ${data.filename_suggestion.extracted_dates && data.filename_suggestion.extracted_dates.length > 0 ? `
                            <div class="detail-group">
                                <span class="detail-label">üìÖ Gefundene Daten:</span>
                                <div class="clickable-items">
                                    ${data.filename_suggestion.extracted_dates.map(date =>
                                        `<span class="clickable-item" onclick="useDate('${date}')">${date}</span>`
                                    ).join('')}
                                </div>
                            </div>
                            ` : ''}

                            ${data.filename_suggestion.extracted_title ? `
                            <div class="detail-group">
                                <span class="detail-label">üìÑ Extrahierter Titel:</span>
                                <span class="clickable-item" onclick="useTitle('${data.filename_suggestion.extracted_title}')">${data.filename_suggestion.extracted_title}</span>
                            </div>
                            ` : ''}

                            ${data.filename_suggestion.subject_keywords && data.filename_suggestion.subject_keywords.length > 0 ? `
                            <div class="detail-group">
                                <span class="detail-label">üè∑Ô∏è Erkannte Kategorien:</span>
                                <span class="detail-value">${data.filename_suggestion.subject_keywords.join(', ')}</span>
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}
                    </div>

                    <div class="preview-section">
                        <h4>üëÅÔ∏è Dokument-Vorschau</h4>
                        <div class="preview-container">
                            <img src="${data.preview}" alt="PDF Preview" class="preview-image">
                        </div>
                    </div>

                    <div class="ai-action">
                        <button class="btn btn-ai-primary" onclick="executeAIWorkflow()">
                            ‚ö° KI-Vorschlag √ºbernehmen
                        </button>
                    </div>
                </div>
            `;
        }

        function createManualContent(data, filename, suggestedCategory) {
            return `
                <div class="manual-workflow">
                    <div class="manual-header">
                        <h3>üë§ Manuelle Auswahl</h3>
                    </div>

                    <div class="category-selection">
                        <h4>üìÇ Kategorie w√§hlen</h4>
                        <select id="manual-category-select" class="category-dropdown">
                            ${window.appCategories.map(category =>
                                `<option value="${category}" ${category === suggestedCategory ? 'selected' : ''}>${category}</option>`
                            ).join('')}
                        </select>
                    </div>

                    <div class="path-selection">
                        <h4>üìÅ Pfad w√§hlen</h4>
                        <input type="text" id="manual-path-input" class="path-input"
                               value="${data.suggested_path || ''}" placeholder="Zielpfad eingeben">

                        <div class="path-browser" id="manual-path-browser">
                            <div class="path-browser-header" onclick="toggleManualPathBrowser()">
                                üìÅ Verf√ºgbare Pfade durchsuchen
                                <span class="collapse-icon">‚ñº</span>
                            </div>
                            <div id="manual-directory-list" style="display: none;">Lade Verzeichnisstruktur...</div>
                        </div>
                    </div>

                    <div class="filename-selection">
                        <h4>üìù Dateiname</h4>
                        <div class="filename-options-simple">
                            <div class="filename-option-simple">
                                <input type="radio" id="manual-original" name="manual-filename" value="original" checked>
                                <label for="manual-original">üìÑ Original: ${filename}</label>
                            </div>
                            ${data.filename_suggestion ? `
                            <div class="filename-option-simple">
                                <input type="radio" id="manual-smart" name="manual-filename" value="smart">
                                <label for="manual-smart">‚ú® Intelligent: ${data.filename_suggestion.suggested_filename}</label>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <div class="manual-actions">
                        <button class="btn btn-manual-primary" onclick="executeManualWorkflow()">
                            üìÅ Manuell verschieben
                        </button>
                    </div>
                </div>
            `;
        }

        // Dokument anzeigen (Legacy)
        function displayDocument(data, filename) {
            try {
                console.log('displayDocument called with:', data, filename);

                if (!data || !data.preview) {
                    console.error('Missing required data fields:', data);
                    showStatus('Fehler: Unvollst√§ndige Dokumentdaten', 'error');
                    return;
                }

                if (!window.appCategories || window.appCategories.length === 0) {
                    console.error('Categories not loaded yet');
                    showStatus('Fehler: Kategorien nicht geladen', 'error');
                    return;
                }

                const suggestedCategory = data.suggested_category || window.appCategories[0];
                console.log('Using suggested category:', suggestedCategory);

                const content = `
                    <!-- Document Processing Workflow -->
                    <div class="processing-workflow">

                        <!-- Step 1: Path Selection -->
                        <div class="workflow-step" id="step-1">
                            <div class="step-header">
                                <span class="step-number">1</span>
                                <h3>üìÅ Zielpfad festlegen</h3>
                                <span id="ai-indicator" class="ai-indicator"></span>
                            </div>

                            <div class="path-selection-section">
                                <div class="suggested-path-display">
                                    <label for="suggested-path-input">Vorgeschlagener Pfad:</label>
                                    <div class="path-input-container">
                                        <input type="text" id="suggested-path-input" class="path-input" value="${data.suggested_path || ''}" readonly>
                                        <button class="btn btn-icon" onclick="copyToClipboard('suggested-path-input')" title="Pfad kopieren">üìã</button>
                                    </div>
                                </div>

                                ${data.suggested_subdirectory ? `
                                <div class="ai-suggestions-display">
                                    <label>ü§ñ KI-Vorschl√§ge:</label>
                                    <div class="ai-suggestion-chips">
                                        <span class="ai-chip category-chip">${data.suggested_category}</span>
                                        <span class="ai-chip subdirectory-chip">${data.suggested_subdirectory}</span>
                                    </div>
                                </div>
                                ` : ''}

                                <div class="path-customization">
                                    <div class="category-selection">
                                        <label for="category-select">Kategorie ausw√§hlen:</label>
                                        <select id="category-select" class="category-select" onchange="updatePath()">
                                            ${window.appCategories.map(cat =>
                                                `<option value="${cat}" ${cat === suggestedCategory ? 'selected' : ''}>${cat}</option>`
                                            ).join('')}
                                        </select>
                                    </div>

                                    <div class="global-search-container">
                                        <label for="global-path-search">üîç Pfad suchen:</label>
                                        <input type="text" id="global-path-search" class="path-search-input" placeholder="Suche in allen Verzeichnissen (z.B. 'Lesekram')">
                                        <div id="global-autocomplete-dropdown" class="autocomplete-dropdown"></div>
                                    </div>
                                </div>

                                <div class="path-browser" id="path-browser">
                                    <div class="path-browser-header" onclick="togglePathBrowser()">
                                        üìÅ Verf√ºgbare Pfade durchsuchen
                                        <span class="collapse-icon">‚ñº</span>
                                    </div>
                                    <div id="directory-list">Lade Verzeichnisstruktur...</div>
                                </div>

                                <div id="smart-suggestions" style="display: none;">
                                    <h4>üéØ Intelligente Pfadvorschl√§ge</h4>
                                    <div id="suggestion-list"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Filename Configuration -->
                        <div class="workflow-step" id="step-2">
                            <div class="step-header">
                                <span class="step-number">2</span>
                                <h3>üìù Dateiname konfigurieren</h3>
                            </div>

                            <div class="filename-configuration compact">
                                <div class="filename-options">
                                    <div class="filename-option" onclick="selectFilenameOption('original')">
                                        <input type="radio" id="keep-original" name="filename-mode" value="original" checked>
                                        <label for="keep-original">
                                            <strong>üìÑ Original</strong>
                                            <div class="filename-preview">${data.filename_suggestion ? data.filename_suggestion.original_filename : filename}</div>
                                        </label>
                                    </div>

                                    ${data.filename_suggestion && data.filename_suggestion.selected_date ? `
                                    <div class="filename-option" onclick="selectFilenameOption('date')">
                                        <input type="radio" id="use-date" name="filename-mode" value="date">
                                        <label for="use-date">
                                            <strong>üìÖ Mit Datum</strong>
                                            <div class="filename-preview">${data.filename_suggestion.selected_date + '_' + data.filename_suggestion.original_filename.replace(/^\\d{4}-\\d{2}-\\d{2}_?/, '')}</div>
                                            <span class="option-badge">${data.filename_suggestion.date_source === 'content' ? 'Aus PDF' : 'Fallback'}</span>
                                        </label>
                                    </div>
                                    ` : ''}

                                    ${data.filename_suggestion ? `
                                    <div class="filename-option" onclick="selectFilenameOption('smart')">
                                        <input type="radio" id="use-smart" name="filename-mode" value="smart">
                                        <label for="use-smart">
                                            <strong>‚ú® Intelligent</strong>
                                            <div class="filename-preview">${data.filename_suggestion.suggested_filename}</div>
                                            <span class="option-badge">${data.filename_suggestion.title_source === 'pdf_content' ? 'PDF-Titel' : 'Fallback'}</span>
                                        </label>
                                    </div>
                                    ` : ''}
                                </div>

                                ${data.filename_suggestion ? `
                                <div class="intelligent-details" id="intelligent-details">
                                    <div class="details-header" onclick="toggleIntelligentDetails()">
                                        <span>üîç Intelligente Analyse-Details</span>
                                        <span class="toggle-icon">‚ñº</span>
                                    </div>
                                    <div class="details-content" style="display: none;">
                                        ${data.filename_suggestion.extracted_title ? `
                                        <div class="detail-item">
                                            <span class="detail-icon">üìÑ</span>
                                            <span class="detail-label">Extrahierter Titel:</span>
                                            <span class="detail-value clickable-value" onclick="useExtractedTitle('${data.filename_suggestion.extracted_title}')">${data.filename_suggestion.extracted_title}</span>
                                        </div>
                                        ` : ''}
                                        ${data.filename_suggestion.extracted_dates && data.filename_suggestion.extracted_dates.length > 0 ? `
                                        <div class="detail-item">
                                            <span class="detail-icon">üìÖ</span>
                                            <span class="detail-label">Gefundene Daten:</span>
                                            <span class="detail-value">${data.filename_suggestion.extracted_dates.map(date => `<span class="clickable-date" onclick="useExtractedDate('${date}')">${date}</span>`).join(', ')}</span>
                                        </div>
                                        ` : ''}
                                        ${data.filename_suggestion.selected_date ? `
                                        <div class="detail-item">
                                            <span class="detail-icon">‚úÖ</span>
                                            <span class="detail-label">Verwendetes Datum:</span>
                                            <span class="detail-value clickable-date" onclick="useExtractedDate('${data.filename_suggestion.selected_date}')">${data.filename_suggestion.selected_date}</span>
                                        </div>
                                        ` : ''}
                                        ${data.filename_suggestion.subject_keywords && data.filename_suggestion.subject_keywords.length > 0 ? `
                                        <div class="detail-item">
                                            <span class="detail-icon">üè∑Ô∏è</span>
                                            <span class="detail-label">Erkannte Kategorien:</span>
                                            <span class="detail-value">${data.filename_suggestion.subject_keywords.join(', ')}</span>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Step 3: Final Actions -->
                        <div class="workflow-step" id="step-3">
                            <div class="step-header">
                                <span class="step-number">3</span>
                                <h3>üöÄ Aktionen ausf√ºhren</h3>
                            </div>

                            <div class="final-summary">
                                <div class="summary-row">
                                    <span class="summary-label">Zielpfad:</span>
                                    <span class="summary-value" id="final-path">${data.suggested_path || ''}</span>
                                </div>
                                <div class="summary-row">
                                    <span class="summary-label">Dateiname:</span>
                                    <span class="summary-value" id="final-filename">${data.filename_suggestion ? data.filename_suggestion.original_filename : filename}</span>
                                </div>
                            </div>

                            <div class="action-buttons">
                                <button class="btn btn-primary" onclick="executeMove()">
                                    üìÅ Nur verschieben
                                </button>
                                <button class="btn btn-success" onclick="executeMoveAndRename()">
                                    ‚ú® Umbenennen & verschieben
                                </button>
                                <button class="btn btn-secondary" onclick="updatePath()">
                                    üîÑ Pfad aktualisieren
                                </button>
                                <button class="btn btn-undo" id="undo-btn" onclick="undoLastAction()" disabled>
                                    ‚Ü∂ R√ºckg√§ngig
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="document-preview">
                        <div class="preview-container">
                            <img src="${data.preview}" alt="PDF Preview" class="preview-image">
                        </div>
                    </div>
                `;

                document.getElementById('document-content').innerHTML = content;
                console.log('Content set successfully');

                // Set AI indicator based on confidence and fallback_used
                setAIIndicator(data);

                // Verzeichnisstruktur laden
                loadDirectoryStructure();

                // Event-Listener f√ºr Kategorie-√Ñnderung und Custom Path
                const categorySelect = document.getElementById('category-select');
                if (categorySelect) {
                    categorySelect.addEventListener('change', function() {
                        updatePath();
                        updateAvailablePaths();
                    });
                }

                // Event-Listener f√ºr Pfadsuche
                setupPathSearch();

                // Event-Listener f√ºr globale Pfadsuche
                setupGlobalPathSearch();

                // Setup new filename toggle functionality
                setupFilenameToggle();

                // Setup intelligent details toggle
                setupIntelligentDetailsToggle();

                // Update final summary initially
                updateFinalSummary();

                // Initial: Verf√ºgbare Pfade basierend auf Kategorie aktualisieren
                updateAvailablePaths();

                // Automatisch √§hnliche Pfade suchen wenn Dokument geladen
                if (filename) {
                    findSimilarPathsAutomatic(filename);
                }

                console.log('displayDocument completed successfully');
            } catch (error) {
                console.error('Error in displayDocument:', error);
                showStatus(`Fehler beim Anzeigen des Dokuments: ${error.message}`, 'error');
            }
        }
        
        // Pfad basierend auf gew√§hlter Kategorie aktualisieren
        function updatePath() {
            if (!currentDocument) return;

            const selectedCategory = document.getElementById('category-select').value;
            const filename = currentDocument.original_path.split('/').pop();
            const sortedDir = currentDocument.suggested_path.split('/').slice(0, -2).join('/');
            const newPath = `${sortedDir}/${selectedCategory}/${filename}`;

            // Update the main suggested path input field (top section)
            const suggestedPathInput = document.getElementById('suggested-path-input');
            if (suggestedPathInput) suggestedPathInput.value = newPath;

            // Legacy support for old elements if they exist
            const newPathDisplay = document.querySelector('.suggested-path-display');
            if (newPathDisplay) newPathDisplay.textContent = newPath;

            const oldPathDisplay = document.getElementById('suggested-path');
            if (oldPathDisplay) oldPathDisplay.textContent = newPath;

            // Update AI indicator to show this is user-modified (fallback)
            const indicator = document.getElementById('ai-indicator');
            if (indicator) {
                indicator.className = 'ai-indicator fallback';
                indicator.textContent = 'üë§ Benutzer-Anpassung';
                indicator.title = 'Dieser Pfad wurde vom Benutzer angepasst';
            }

            currentDocument.suggested_path = newPath;
        }

        // Verf√ºgbare Pfade basierend auf ausgew√§hlter Kategorie filtern
        function updateAvailablePaths() {
            const categorySelect = document.getElementById('category-select');
            const directoryList = document.getElementById('directory-list');

            if (!categorySelect || !directoryList || !directoryStructure) {
                return;
            }

            const selectedCategory = categorySelect.value;
            console.log('Updating available paths for category:', selectedCategory);

            // Finde die ausgew√§hlte Kategorie in der Struktur
            const categoryData = directoryStructure[selectedCategory];

            if (!categoryData || !categoryData.children) {
                // Keine Unterverzeichnisse vorhanden
                directoryList.innerHTML = '<div style="padding: 10px; color: #666;">Keine Unterverzeichnisse verf√ºgbar</div>';
                return;
            }

            // Zeige nur die Unterverzeichnisse der ausgew√§hlten Kategorie
            directoryList.innerHTML = '';
            renderDirectoryStructure(categoryData.children, categoryData.path, directoryList, 0);

            // Aktualisiere auch die Autocomplete-Liste f√ºr die gefilterten Pfade
            allDirectories = flattenDirectoryForAutocomplete(categoryData.children, categoryData.path, 0);
        }

        // Move-Operation ausf√ºhren
        async function executeMove() {
            if (!currentDocument) return;

            // Use the suggested path input field as primary source
            const suggestedPathInput = document.getElementById('suggested-path-input');
            const pathDisplay = document.querySelector('.suggested-path-display');
            const finalPath = suggestedPathInput ? suggestedPathInput.value :
                             (pathDisplay ? pathDisplay.textContent : currentDocument.suggested_path);

            try {
                const response = await fetch('/api/move-document', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        source_path: currentDocument.original_path,
                        target_path: finalPath
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Speichere letzte Aktion f√ºr Undo
                    lastAction = {
                        type: 'move',
                        source_path: finalPath,
                        target_path: currentDocument.original_path,
                        timestamp: new Date().toISOString()
                    };
                    document.getElementById('undo-btn').disabled = false;

                    showStatus(`‚úÖ Datei erfolgreich verschoben nach: ${finalPath}`, 'success');
                    // Dateiliste neu laden
                    setTimeout(() => {
                        loadFiles();
                        document.getElementById('intelligent-content').innerHTML =
                            '<div class="loading">W√§hle eine neue Datei aus der Liste</div>';
                        document.getElementById('manual-content').innerHTML =
                            '<div class="loading">W√§hle eine neue Datei aus der Liste</div>';
                    }, 2000);
                } else {
                    showStatus(`‚ùå Fehler: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Error moving document:', error);
                showStatus('‚ùå Fehler beim Verschieben der Datei', 'error');
            }
        }
        
        // Zuf√§lliges Dokument ausw√§hlen
        async function selectRandomDocument() {
            try {
                const response = await fetch('/api/random-document');
                const randomDoc = await response.json();
                
                if (response.ok) {
                    // Vorhandene selectFile Funktion aufrufen
                    selectFile(randomDoc.path, randomDoc.name);
                    
                    // Visuelles Feedback
                    const fileItems = document.querySelectorAll('.file-item');
                    fileItems.forEach(item => {
                        if (item.querySelector('.file-name').textContent.includes(randomDoc.name)) {
                            item.classList.add('active');
                            item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        } else {
                            item.classList.remove('active');
                        }
                    });
                } else {
                    showStatus(`‚ùå Fehler: ${randomDoc.error}`, 'error');
                }
            } catch (error) {
                console.error('Error selecting random document:', error);
                showStatus('‚ùå Fehler beim Ausw√§hlen eines zuf√§lligen Dokuments', 'error');
            }
        }
        
        // Status-Nachricht anzeigen
        function showStatus(message, type) {
            const statusContainer = document.getElementById('status-container');
            statusContainer.innerHTML = `
                <div class="status-message status-${type}">
                    ${message}
                </div>
            `;
            
            // Nach 5 Sekunden automatisch ausblenden
            setTimeout(() => {
                statusContainer.innerHTML = '';
            }, 5000);
        }
        
        // Neue Funktionen f√ºr Verzeichnisstruktur
        async function loadDirectoryStructure() {
            try {
                const response = await fetch('/api/directory-structure');
                const data = await response.json();
                console.log('Directory structure data:', data);

                const directoryList = document.getElementById('directory-list');
                if (!directoryList) {
                    console.error('Directory list element not found');
                    return;
                }

                directoryList.innerHTML = '';

                // Speichere Struktur f√ºr sp√§tere Nutzung
                directoryStructure = data.structure || data;

                // Erstelle flache Liste f√ºr Autocomplete
                allDirectories = flattenDirectoryForAutocomplete(data.structure || data, data.base_path || '');

                // Erstelle globale Liste f√ºr die globale Suche
                globalDirectories = createGlobalDirectoryList(data.structure || data, data.base_path || '');

                // Rendere hierarchische Ansicht
                renderDirectoryStructure(data.structure || data, data.base_path || '', directoryList);

            } catch (error) {
                console.error('Error loading directory structure:', error);
                const directoryList = document.getElementById('directory-list');
                if (directoryList) {
                    directoryList.innerHTML =
                        '<div style="padding: 10px; color: #666;">Fehler beim Laden der Verzeichnisstruktur</div>';
                }
            }
        }

        function renderDirectoryStructure(structure, basePath, container, level = 0) {
            for (const [name, dirInfo] of Object.entries(structure)) {
                // Handle new API structure where each entry has path, children, etc.
                const fullPath = dirInfo.path || `${basePath}/${name}`;
                const children = dirInfo.children || {};
                const hasChildren = Object.keys(children).length > 0;

                const div = document.createElement('div');
                div.className = `directory-item directory-level-${level} ${!hasChildren ? 'no-children' : ''} ${level > 0 ? '' : 'show'}`;
                div.dataset.path = fullPath;
                div.dataset.level = level;

                const expandIcon = hasChildren ? '‚ñ∂' : '';
                div.innerHTML = `
                    <span class="expand-icon">${expandIcon}</span>
                    <span>üìÅ ${name}</span>
                `;

                div.onclick = (e) => {
                    e.stopPropagation();

                    // Verzeichnis ausw√§hlen
                    selectDirectory(fullPath);

                    // Aufklappen/Zuklappen wenn Kinder vorhanden
                    if (hasChildren) {
                        toggleDirectoryExpansion(div, level);
                    }
                };

                container.appendChild(div);

                // Kinder hinzuf√ºgen (initial versteckt)
                if (hasChildren) {
                    renderDirectoryStructure(children, basePath, container, level + 1);
                }
            }
        }

        function toggleDirectoryExpansion(dirElement, level) {
            const isExpanded = dirElement.classList.contains('expanded');
            dirElement.classList.toggle('expanded');

            // Alle Kinder-Elemente finden und ein-/ausblenden
            let nextElement = dirElement.nextElementSibling;
            while (nextElement && parseInt(nextElement.dataset.level) > level) {
                const elementLevel = parseInt(nextElement.dataset.level);

                if (elementLevel === level + 1) {
                    // Direkte Kinder
                    if (isExpanded) {
                        nextElement.classList.remove('show');
                        nextElement.classList.remove('expanded'); // Zuklappen von Unter-Verzeichnissen
                    } else {
                        nextElement.classList.add('show');
                    }
                } else if (elementLevel > level + 1) {
                    // Enkel und tiefer - immer verstecken wenn Eltern zugeklappt werden
                    if (isExpanded) {
                        nextElement.classList.remove('show');
                        nextElement.classList.remove('expanded');
                    }
                }

                nextElement = nextElement.nextElementSibling;
            }
        }

        function selectDirectory(dirPath) {
            // Markiere ausgew√§hltes Verzeichnis
            document.querySelectorAll('.directory-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.classList.add('selected');

            // Aktualisiere Pfad mit aktueller Datei
            if (currentDocument) {
                const filename = currentDocument.original_path.split('/').pop();
                const newPath = `${dirPath}/${filename}`;

                // Update the main suggested path input field (top section)
                const suggestedPathInput = document.getElementById('suggested-path-input');
                if (suggestedPathInput) suggestedPathInput.value = newPath;

                // Legacy support for old elements if they exist
                const pathDisplay = document.querySelector('.suggested-path-display');
                if (pathDisplay) pathDisplay.textContent = newPath;

                const legacyPath = document.getElementById('suggested-path');
                if (legacyPath) legacyPath.textContent = newPath;

                const customPath = document.getElementById('custom-path');
                if (customPath) customPath.value = newPath;

                // Update AI indicator to show this is user-selected directory
                const indicator = document.getElementById('ai-indicator');
                if (indicator) {
                    indicator.className = 'ai-indicator fallback';
                    indicator.textContent = 'üë§ Benutzer-Auswahl';
                    indicator.title = 'Dieser Pfad wurde vom Benutzer aus der Verzeichnisstruktur ausgew√§hlt';
                }

                currentDocument.suggested_path = newPath;
            }
        }

        function updateSystemStatus(systemStats, preloadStatus, cachedCount, totalFiles) {
            // Element existiert nicht mehr, nur Footer aktualisieren
            updateSystemMetricsFooter(systemStats, preloadStatus, cachedCount, totalFiles);
        }

        // Intelligentes Refresh-System
        let refreshInterval;

        function startSmartRefresh() {
            // Kontinuierliches Refresh f√ºr Systemmetriken
            if (refreshInterval) clearInterval(refreshInterval);

            refreshInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/system-status');
                    const data = await response.json();

                    // Aktualisiere Footer-Metriken
                    updateSystemMetricsFooter(data.system_stats, data.preload_status, data.cached_count, 0);

                    console.log('System metrics updated:', data.system_stats);
                } catch (error) {
                    console.error('Error updating system metrics:', error);
                }
            }, 5000); // Alle 5 Sekunden

            // Initial Update
            updateSystemMetrics();
        }

        async function updateSystemMetrics() {
            try {
                const response = await fetch('/api/system-status');
                const data = await response.json();
                updateSystemMetricsFooter(data.system_stats, data.preload_status, data.cached_count, 0);
                console.log('Initial system metrics loaded:', data.system_stats);
            } catch (error) {
                console.error('Error loading initial system metrics:', error);
            }
        }

        // Neue Funktionen
        function togglePathBrowser() {
            const pathBrowser = document.getElementById('path-browser');
            pathBrowser.classList.toggle('collapsed');
        }

        function setupPathSearch() {
            const searchInput = document.getElementById('path-search');
            const dropdown = document.getElementById('autocomplete-dropdown');

            // Check if elements exist before setting up listeners
            if (!searchInput || !dropdown) {
                console.log('Path search elements not found, skipping setup');
                return;
            }
            let selectedIndex = -1;

            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                if (query.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                const matches = allDirectories.filter(dir =>
                    dir.name.toLowerCase().includes(query) ||
                    dir.path.toLowerCase().includes(query)
                ).slice(0, 10); // Limit zu 10 Ergebnissen

                if (matches.length > 0) {
                    dropdown.innerHTML = matches.map((dir, index) => `
                        <div class="autocomplete-item" data-index="${index}" data-path="${dir.path}">
                            ${dir.display}
                        </div>
                    `).join('');
                    dropdown.style.display = 'block';
                    selectedIndex = -1;
                } else {
                    dropdown.style.display = 'none';
                }
            });

            searchInput.addEventListener('keydown', function(e) {
                const items = dropdown.querySelectorAll('.autocomplete-item');

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateSelection(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    updateSelection(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedIndex >= 0 && items[selectedIndex]) {
                        selectFromAutocomplete(items[selectedIndex].dataset.path);
                    }
                } else if (e.key === 'Escape') {
                    dropdown.style.display = 'none';
                    selectedIndex = -1;
                }
            });

            dropdown.addEventListener('click', function(e) {
                if (e.target.classList.contains('autocomplete-item')) {
                    selectFromAutocomplete(e.target.dataset.path);
                }
            });

            function updateSelection(items) {
                items.forEach((item, index) => {
                    item.classList.toggle('selected', index === selectedIndex);
                });
            }

            function selectFromAutocomplete(path) {
                selectDirectory(path);
                searchInput.value = '';
                dropdown.style.display = 'none';
                selectedIndex = -1;
            }

            // Schlie√üe Dropdown bei Klick au√üerhalb
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }

        function setupGlobalPathSearch() {
            const searchInput = document.getElementById('global-path-search');
            const dropdown = document.getElementById('global-autocomplete-dropdown');

            // Check if elements exist before setting up listeners
            if (!searchInput || !dropdown) {
                console.log('Global path search elements not found, skipping setup');
                return;
            }

            let selectedIndex = -1;

            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                if (query.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                const matches = globalDirectories.filter(dir =>
                    dir.name.toLowerCase().includes(query) ||
                    dir.path.toLowerCase().includes(query)
                ).slice(0, 10);

                if (matches.length > 0) {
                    dropdown.innerHTML = matches.map((dir, index) => `
                        <div class="autocomplete-item" data-index="${index}" data-path="${dir.path}" data-category="${dir.category}">
                            <strong>${dir.category}</strong> ‚Üí ${dir.display}
                        </div>
                    `).join('');
                    dropdown.style.display = 'block';
                    selectedIndex = -1;
                } else {
                    dropdown.style.display = 'none';
                }
            });

            searchInput.addEventListener('keydown', function(e) {
                const items = dropdown.querySelectorAll('.autocomplete-item');

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateGlobalSelection(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    updateGlobalSelection(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedIndex >= 0 && items[selectedIndex]) {
                        selectFromGlobalAutocomplete(items[selectedIndex].dataset.path, items[selectedIndex].dataset.category);
                    }
                } else if (e.key === 'Escape') {
                    dropdown.style.display = 'none';
                    selectedIndex = -1;
                }
            });

            dropdown.addEventListener('click', function(e) {
                if (e.target.classList.contains('autocomplete-item')) {
                    selectFromGlobalAutocomplete(e.target.dataset.path, e.target.dataset.category);
                }
            });

            function updateGlobalSelection(items) {
                items.forEach((item, index) => {
                    item.classList.toggle('selected', index === selectedIndex);
                });
            }

            function selectFromGlobalAutocomplete(path, category) {
                // Setze die Kategorie automatisch
                const categorySelect = document.getElementById('category-select');
                if (categorySelect) {
                    categorySelect.value = category;
                }

                // Aktualisiere den vorgeschlagenen Pfad
                if (currentDocument) {
                    const filename = currentDocument.original_path.split('/').pop();
                    const newPath = `${path}/${filename}`;

                    // Aktualisiere das vorgeschlagene Pfad-Eingabefeld (top section)
                    const suggestedPathInput = document.getElementById('suggested-path-input');
                    if (suggestedPathInput) {
                        suggestedPathInput.value = newPath;
                    }

                    // Legacy support
                    const pathDisplay = document.querySelector('.suggested-path-display');
                    if (pathDisplay) {
                        pathDisplay.textContent = newPath;
                    }

                    // Update AI indicator to show this is user search result
                    const indicator = document.getElementById('ai-indicator');
                    if (indicator) {
                        indicator.className = 'ai-indicator fallback';
                        indicator.textContent = 'üîç Benutzer-Suche';
                        indicator.title = 'Dieser Pfad wurde durch Benutzer-Suche gefunden';
                    }

                    currentDocument.suggested_path = newPath;
                }

                // Aktualisiere verf√ºgbare Pfade basierend auf neuer Kategorie
                updatePath();
                updateAvailablePaths();

                // Verstecke Dropdown und leere Suchfeld
                searchInput.value = '';
                dropdown.style.display = 'none';
                selectedIndex = -1;
            }

            // Schlie√üe Dropdown bei Klick au√üerhalb
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }

        function flattenDirectoryForAutocomplete(structure, basePath, level = 0, result = []) {
            for (const [name, dirInfo] of Object.entries(structure)) {
                // Handle new API structure
                const fullPath = dirInfo.path || `${basePath}/${name}`;
                const children = dirInfo.children || {};
                const display = '  '.repeat(level) + (level > 0 ? 'üìÅ ' : '') + name;

                result.push({
                    name: name,
                    path: fullPath,
                    display: display,
                    level: level
                });

                if (Object.keys(children).length > 0) {
                    flattenDirectoryForAutocomplete(children, fullPath, level + 1, result);
                }
            }
            return result;
        }

        function createGlobalDirectoryList(structure, basePath) {
            const result = [];

            for (const [categoryName, categoryInfo] of Object.entries(structure)) {
                // F√ºge die Kategorie selbst hinzu
                result.push({
                    name: categoryName,
                    path: categoryInfo.path || `${basePath}/${categoryName}`,
                    display: categoryName,
                    level: 0,
                    category: categoryName
                });

                // F√ºge alle Unterverzeichnisse mit Kategorie-Information hinzu
                if (categoryInfo.children && Object.keys(categoryInfo.children).length > 0) {
                    addChildrenToGlobalList(categoryInfo.children, categoryInfo.path || `${basePath}/${categoryName}`, 1, categoryName, result);
                }
            }

            return result;
        }

        function addChildrenToGlobalList(children, basePath, level, category, result) {
            for (const [name, dirInfo] of Object.entries(children)) {
                const fullPath = dirInfo.path || `${basePath}/${name}`;
                const display = '  '.repeat(level) + name;

                result.push({
                    name: name,
                    path: fullPath,
                    display: display,
                    level: level,
                    category: category
                });

                if (dirInfo.children && Object.keys(dirInfo.children).length > 0) {
                    addChildrenToGlobalList(dirInfo.children, fullPath, level + 1, category, result);
                }
            }
        }

        // AI Indicator setzen basierend auf Confidence und Fallback-Status
        function setAIIndicator(data) {
            const indicator = document.getElementById('ai-indicator');
            if (!indicator) return;

            console.log('Setting AI indicator with data:', {
                confidence: data.confidence,
                fallback_used: data.fallback_used
            });

            // Bestimme ob AI oder Fallback verwendet wurde
            const isAIPowered = data.confidence === 'high' && !data.fallback_used;

            if (isAIPowered) {
                indicator.className = 'ai-indicator ai-powered';
                indicator.textContent = 'ü§ñ KI-Vorschlag';
                indicator.title = 'Dieser Pfad wurde von der KI vorgeschlagen';
            } else {
                indicator.className = 'ai-indicator fallback';
                indicator.textContent = 'üîÑ Fallback';
                indicator.title = 'Dieser Pfad wurde vom Fallback-System vorgeschlagen (KI nicht verf√ºgbar)';
            }
        }

        // Kategorien vom Backend laden
        async function loadCategories() {
            try {
                const response = await fetch('/api/directory-structure');
                const data = await response.json();
                console.log('Raw API response:', data);

                // Extract directory names as categories from structure
                if (data.structure && typeof data.structure === 'object') {
                    window.appCategories = Object.keys(data.structure).sort();
                    console.log('Loaded categories from API structure:', window.appCategories);
                } else {
                    // Fallback if structure is not available
                    window.appCategories = Object.keys(data).filter(key => key !== 'base_path').sort();
                    console.log('Loaded categories from API root (fallback):', window.appCategories);
                }
            } catch (error) {
                console.error('Error loading categories:', error);
                // Fallback Kategorien - aus Documents-Struktur
                window.appCategories = [
                    '0001_scanbot', '10_arbeit', '11 finanzen', '12 schriftverkehr',
                    '13 telefon internet', '14 telekommunikation', '15 versicherung',
                    '16 wohnen', '17 sonstiges', '18 gesundheit', '19 fahrzeuge',
                    '1_halle', '20 steuern', '21_gifs', '2 pers√∂nliche dokumente',
                    '3a Gesundheit', '4 Vertr√§ge', '5 Finanzen', '6 Politik',
                    '7 Arbeit', '8 wohnen', '9 Fahrzeuge', 'arbeit', 'Sonstiges'
                ];
                console.log('Using fallback categories:', window.appCategories);
            }
        }

        async function undoLastAction() {
            if (!lastAction) return;

            try {
                const response = await fetch('/api/move-document', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        source_path: lastAction.source_path,
                        target_path: lastAction.target_path
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus(`‚Ü∂ Aktion r√ºckg√§ngig gemacht: Datei zur√ºck nach ${lastAction.target_path}`, 'success');
                    lastAction = null;
                    document.getElementById('undo-btn').disabled = true;

                    // Dateiliste neu laden
                    setTimeout(() => {
                        loadFiles();
                        document.getElementById('intelligent-content').innerHTML =
                            '<div class="loading">W√§hle eine neue Datei aus der Liste</div>';
                        document.getElementById('manual-content').innerHTML =
                            '<div class="loading">W√§hle eine neue Datei aus der Liste</div>';
                    }, 2000);
                } else {
                    showStatus(`‚ùå Fehler beim R√ºckg√§ngigmachen: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Error undoing action:', error);
                showStatus('‚ùå Fehler beim R√ºckg√§ngigmachen der Aktion', 'error');
            }
        }

        // Intelligente Pfadvorschl√§ge
        async function findSimilarPaths() {
            if (!currentDocument) {
                alert('Bitte w√§hlen Sie zuerst ein Dokument aus');
                return;
            }

            const filename = currentDocument.original_path.split('/').pop();
            await findSimilarPathsAutomatic(filename);
        }

        async function findSimilarPathsAutomatic(filename) {
            try {
                const response = await fetch('/api/suggest-alternative-paths', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ filename: filename })
                });

                const data = await response.json();

                if (response.ok && data.similar_paths && data.similar_paths.length > 0) {
                    displaySmartSuggestions(data.similar_paths.slice(0, 3)); // Top 3 Vorschl√§ge
                }
            } catch (error) {
                console.error('Error finding similar paths:', error);
            }
        }

        function displaySmartSuggestions(suggestions) {
            const container = document.getElementById('suggestion-list');
            const smartSuggestionsDiv = document.getElementById('smart-suggestions');

            if (suggestions.length === 0) {
                smartSuggestionsDiv.style.display = 'none';
                return;
            }

            container.innerHTML = suggestions.map(suggestion => `
                <div class="smart-suggestion" onclick="applySuggestion('${suggestion.path}')">
                    <div class="suggestion-path">üìÅ ${suggestion.path}</div>
                    <div class="suggestion-score">üéØ ${(suggestion.similarity * 100).toFixed(1)}% √Ñhnlichkeit mit "${suggestion.directory}"</div>
                </div>
            `).join('');

            smartSuggestionsDiv.style.display = 'block';
        }

        function applySuggestion(suggestedPath) {
            if (!currentDocument) return;

            const filename = currentDocument.original_path.split('/').pop();
            const fullPath = `${suggestedPath}/${filename}`;

            document.getElementById('suggested-path').textContent = fullPath;
            document.getElementById('custom-path').value = fullPath;
            currentDocument.suggested_path = fullPath;

            // Verstecke Vorschl√§ge nach Auswahl
            document.getElementById('smart-suggestions').style.display = 'none';

            // Visual Feedback
            const pathElement = document.getElementById('suggested-path');
            pathElement.style.background = '#d4edda';
            pathElement.style.border = '2px solid #28a745';

            setTimeout(() => {
                pathElement.style.background = '#e8f5e8';
                pathElement.style.border = '1px solid #ddd';
            }, 2000);
        }

        // Initial laden und Smart Refresh starten
        async function initializeApp() {
            console.log('Initializing app...');
            try {
                await loadCategories();
                console.log('Categories loaded:', window.appCategories);
                await loadFiles();
                console.log('Files loaded');
                startSmartRefresh();
                console.log('Smart refresh started');
            } catch (error) {
                console.error('Initialization error:', error);
                // Fallback: Versuche trotzdem zu laden
                window.appCategories = ['Sonstiges'];
                loadFiles();
                startSmartRefresh();
            }
        }

        // DOM ready checker
        function updateSystemMetricsFooter(systemStats, preloadStatus, cachedCount, totalFiles) {
            document.getElementById('cpu-usage').textContent = `${systemStats.cpu_percent || 0}%`;
            document.getElementById('memory-usage').textContent = `${systemStats.memory_percent || 0}%`;
            document.getElementById('disk-usage').textContent = `${systemStats.disk_usage || 0}%`;
            document.getElementById('cached-files').textContent = cachedCount || 0;

            // LM Studio status indicator
            const lmStudioStatus = document.getElementById('lm-studio-status');
            if (preloadStatus.is_running) {
                lmStudioStatus.textContent = 'üü¢';
                lmStudioStatus.title = 'LM Studio aktiv';
            } else {
                lmStudioStatus.textContent = '‚ö™';
                lmStudioStatus.title = 'LM Studio bereit';
            }
        }



        // New Functions for Enhanced UI
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                navigator.clipboard.writeText(element.value || element.textContent);
                showStatus('Text kopiert!', 'success');
            }
        }

        function setupFilenameToggle() {
            const radios = document.querySelectorAll('input[name="filename-mode"]');
            const finalFilename = document.getElementById('final-filename');

            // Setup visual selection for filename options
            document.querySelectorAll('.filename-option').forEach(option => {
                option.addEventListener('click', function() {
                    const radio = this.querySelector('input[type="radio"]');
                    if (radio) {
                        radio.checked = true;

                        // Update visual selection
                        document.querySelectorAll('.filename-option').forEach(opt => opt.classList.remove('selected'));
                        this.classList.add('selected');

                        updateFinalSummary();
                    }
                });
            });

            radios.forEach(radio => {
                radio.addEventListener('change', function() {
                    // Update visual selection
                    document.querySelectorAll('.filename-option').forEach(opt => opt.classList.remove('selected'));
                    this.closest('.filename-option').classList.add('selected');

                    updateFinalSummary();
                });
            });

            // Set initial selection
            const checkedRadio = document.querySelector('input[name="filename-mode"]:checked');
            if (checkedRadio) {
                checkedRadio.closest('.filename-option').classList.add('selected');
            }
        }

        function updateFinalSummary() {
            const finalPath = document.getElementById('final-path');
            const finalFilename = document.getElementById('final-filename');
            const suggestedPath = document.getElementById('suggested-path-input');

            if (finalPath && suggestedPath) {
                finalPath.textContent = suggestedPath.value;
            }

            // Update filename based on selection
            const selectedMode = document.querySelector('input[name="filename-mode"]:checked');
            if (selectedMode && finalFilename && currentDocument) {
                if (selectedMode.value === 'smart' && currentDocument.filename_suggestion) {
                    finalFilename.textContent = currentDocument.filename_suggestion.suggested_filename;
                } else if (selectedMode.value === 'date' && currentDocument.filename_suggestion && currentDocument.filename_suggestion.selected_date) {
                    const originalName = currentDocument.filename_suggestion.original_filename.replace(/^\d{4}-\d{2}-\d{2}_?/, '');
                    finalFilename.textContent = currentDocument.filename_suggestion.selected_date + '_' + originalName;
                } else if (currentDocument.filename_suggestion) {
                    finalFilename.textContent = currentDocument.filename_suggestion.original_filename;
                }
            }
        }

        async function executeMoveAndRename() {
            console.log('executeMoveAndRename called');
            if (!currentDocument) {
                showStatus('Kein Dokument ausgew√§hlt', 'error');
                console.log('No document selected');
                return;
            }

            const selectedMode = document.querySelector('input[name="filename-mode"]:checked');
            const targetPath = document.getElementById('suggested-path-input').value;

            console.log('Selected mode:', selectedMode?.value);
            console.log('Target path:', targetPath);
            console.log('Current document:', currentDocument);
            console.log('Has filename_suggestion:', !!currentDocument.filename_suggestion);

            if (!targetPath || targetPath.trim() === '') {
                showStatus('Kein Zielpfad angegeben', 'error');
                console.log('No target path provided');
                return;
            }

            let filename;
            if (selectedMode && selectedMode.value === 'smart' && currentDocument.filename_suggestion) {
                filename = currentDocument.filename_suggestion.suggested_filename;
                console.log('Using smart filename:', filename);
            } else if (selectedMode && selectedMode.value === 'date' && currentDocument.filename_suggestion && currentDocument.filename_suggestion.selected_date) {
                const originalName = currentDocument.filename_suggestion.original_filename.replace(/^\d{4}-\d{2}-\d{2}_?/, '');
                filename = currentDocument.filename_suggestion.selected_date + '_' + originalName;
                console.log('Using date filename:', filename);
            } else if (currentDocument.filename_suggestion) {
                filename = currentDocument.filename_suggestion.original_filename;
                console.log('Using original filename from suggestion:', filename);
            } else {
                filename = currentDocument.original_path.split('/').pop();
                console.log('Using filename from path:', filename);
            }

            // Ensure proper path construction
            const cleanTargetPath = targetPath.replace(/\/+$/, ''); // Remove trailing slashes
            const fullTargetPath = cleanTargetPath + '/' + filename;

            console.log('Final filename:', filename);
            console.log('Clean target path:', cleanTargetPath);
            console.log('Full target path:', fullTargetPath);

            try {
                showStatus('Dokument wird umbenannt und verschoben...', 'info');

                const requestData = {
                    source_path: currentDocument.original_path,
                    target_path: fullTargetPath
                };

                console.log('Sending move request:', requestData);

                const response = await fetch('/api/move-document', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response data:', result);

                if (result.success) {
                    showStatus(`‚ú® Dokument erfolgreich umbenannt und verschoben nach: ${result.target_path}`, 'success');

                    // Update undo functionality
                    lastAction = {
                        type: 'move_and_rename',
                        source: currentDocument.original_path,
                        target: result.target_path,
                        timestamp: new Date().toISOString()
                    };

                    document.getElementById('undo-btn').disabled = false;

                    // Refresh file list
                    await loadFiles();

                    // Clear current document
                    document.getElementById('intelligent-content').innerHTML =
                        '<div class="loading">W√§hlen Sie eine PDF-Datei aus der Liste aus</div>';
                    document.getElementById('manual-content').innerHTML =
                        '<div class="loading">W√§hlen Sie eine PDF-Datei aus der Liste aus</div>';
                    currentDocument = null;
                } else {
                    showStatus(`Fehler beim Verschieben: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error during move and rename:', error);
                showStatus('Fehler beim Umbenennen und Verschieben', 'error');
            }
        }

        // New functions for compact layout and clickable options
        function selectFilenameOption(option) {
            const radio = document.getElementById(option === 'original' ? 'keep-original' : option === 'date' ? 'use-date' : 'use-smart');
            if (radio) {
                radio.checked = true;

                // Update visual selection
                document.querySelectorAll('.filename-option').forEach(opt => opt.classList.remove('selected'));
                radio.closest('.filename-option').classList.add('selected');

                updateFinalSummary();
            }
        }

        function toggleIntelligentDetails() {
            const content = document.querySelector('.details-content');
            const icon = document.querySelector('.toggle-icon');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.classList.add('rotated');
            } else {
                content.style.display = 'none';
                icon.classList.remove('rotated');
            }
        }

        function setupIntelligentDetailsToggle() {
            // Setup is done in HTML, function exists for consistency
        }

        function useExtractedDate(date) {
            if (!currentDocument || !currentDocument.filename_suggestion) return;

            // Create a new filename with the clicked date
            const originalName = currentDocument.filename_suggestion.original_filename.replace(/^\d{4}-\d{2}-\d{2}_?/, '');
            const newFilename = `${date}_${originalName}`;

            // Update the date option preview
            const dateOption = document.querySelector('input[name="filename-mode"][value="date"]');
            if (dateOption) {
                const preview = dateOption.closest('.filename-option').querySelector('.filename-preview');
                if (preview) {
                    preview.textContent = newFilename;
                }

                // Select the date option
                selectFilenameOption('date');

                // Update currentDocument with new date
                currentDocument.filename_suggestion.selected_date = date;

                showStatus(`üìÖ Datum ${date} ausgew√§hlt`, 'success');
            }
        }

        function useExtractedTitle(title) {
            if (!currentDocument || !currentDocument.filename_suggestion) return;

            // Create a new filename with the clicked title
            const selectedDate = currentDocument.filename_suggestion.selected_date || new Date().toISOString().split('T')[0];
            const newFilename = `${selectedDate}_${title}.pdf`;

            // Update the smart option preview
            const smartOption = document.querySelector('input[name="filename-mode"][value="smart"]');
            if (smartOption) {
                const preview = smartOption.closest('.filename-option').querySelector('.filename-preview');
                if (preview) {
                    preview.textContent = newFilename;
                }

                // Select the smart option
                selectFilenameOption('smart');

                // Update currentDocument with new filename
                currentDocument.filename_suggestion.suggested_filename = newFilename;

                showStatus(`üìÑ Titel "${title}" ausgew√§hlt`, 'success');
            }
        }

        // New Workflow Functions
        function setupNewWorkflowEvents() {
            // Setup manual category change
            const categorySelect = document.getElementById('manual-category-select');
            if (categorySelect) {
                categorySelect.addEventListener('change', updateManualPath);
            }

            // Setup manual path browser
            loadDirectoryStructureManual();
        }

        function selectAICategory(category) {
            const manualSelect = document.getElementById('manual-category-select');
            if (manualSelect) {
                manualSelect.value = category;
                updateManualPath();
            }
            showStatus(`üìÇ Kategorie "${category}" √ºbernommen`, 'success');
        }

        function selectAIFilename() {
            if (currentDocument && currentDocument.filename_suggestion) {
                // Update manual radio to smart
                const smartRadio = document.getElementById('manual-smart');
                if (smartRadio) {
                    smartRadio.checked = true;
                }
                showStatus(`üìÑ KI-Dateiname √ºbernommen`, 'success');
            }
        }

        function useDate(date) {
            if (currentDocument && currentDocument.filename_suggestion) {
                currentDocument.filename_suggestion.selected_date = date;

                // Update filename display
                const cleanName = currentDocument.filename_suggestion.original_filename.replace(/^\d{4}-\d{2}-\d{2}_?/, '');
                const newFilename = `${date}_${cleanName}`;

                // Update manual smart option if it exists
                const smartLabel = document.querySelector('label[for="manual-smart"]');
                if (smartLabel) {
                    smartLabel.innerHTML = `‚ú® Intelligent: ${newFilename}`;
                }

                currentDocument.filename_suggestion.suggested_filename = newFilename;
                showStatus(`üìÖ Datum ${date} f√ºr Dateiname verwendet`, 'success');
            }
        }

        function useTitle(title) {
            if (currentDocument && currentDocument.filename_suggestion) {
                const date = currentDocument.filename_suggestion.selected_date || new Date().toISOString().split('T')[0];
                const newFilename = `${date}_${title}.pdf`;

                // Update manual smart option if it exists
                const smartLabel = document.querySelector('label[for="manual-smart"]');
                if (smartLabel) {
                    smartLabel.innerHTML = `‚ú® Intelligent: ${newFilename}`;
                }

                currentDocument.filename_suggestion.suggested_filename = newFilename;
                showStatus(`üìÑ Titel "${title}" f√ºr Dateiname verwendet`, 'success');
            }
        }

        function updateManualPath() {
            const categorySelect = document.getElementById('manual-category-select');
            const pathInput = document.getElementById('manual-path-input');

            if (categorySelect && pathInput && currentDocument) {
                const selectedCategory = categorySelect.value;
                const sortedDir = currentDocument.suggested_path.split('/').slice(0, -2).join('/');
                const newPath = `${sortedDir}/${selectedCategory}`;
                pathInput.value = newPath;
            }
        }

        function executeAIWorkflow() {
            if (!currentDocument) {
                showStatus('Kein Dokument ausgew√§hlt', 'error');
                return;
            }

            const sourcePath = currentDocument.original_path;
            const filename = currentDocument.filename_suggestion ?
                currentDocument.filename_suggestion.suggested_filename :
                currentDocument.original_path.split('/').pop();

            const category = currentDocument.suggested_category;
            const sortedDir = currentDocument.suggested_path.split('/').slice(0, -2).join('/');
            const targetPath = `${sortedDir}/${category}/${filename}`;

            executeMove(sourcePath, targetPath, 'KI-Workflow');
        }

        function executeManualWorkflow() {
            if (!currentDocument) {
                showStatus('Kein Dokument ausgew√§hlt', 'error');
                return;
            }

            const sourcePath = currentDocument.original_path;
            const pathInput = document.getElementById('manual-path-input');
            const filenameRadios = document.querySelectorAll('input[name="manual-filename"]');

            let filename;
            const selectedRadio = Array.from(filenameRadios).find(radio => radio.checked);

            if (selectedRadio && selectedRadio.value === 'smart' && currentDocument.filename_suggestion) {
                filename = currentDocument.filename_suggestion.suggested_filename;
            } else {
                filename = currentDocument.original_path.split('/').pop();
            }

            const targetPath = `${pathInput.value}/${filename}`;

            executeMove(sourcePath, targetPath, 'Manueller Workflow');
        }

        function executeMove(sourcePath, targetPath, workflowType) {
            showStatus(`${workflowType}: Dokument wird verschoben...`, 'info');

            fetch('/api/move-document', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    source_path: sourcePath,
                    target_path: targetPath
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showStatus(`‚úÖ ${workflowType}: Erfolgreich nach ${result.target_path}`, 'success');

                    // Refresh and clear
                    setTimeout(() => {
                        loadFiles();
                        document.getElementById('intelligent-content').innerHTML =
                            '<div class="loading">W√§hlen Sie eine neue Datei aus der Liste</div>';
                        document.getElementById('manual-content').innerHTML =
                            '<div class="loading">W√§hlen Sie eine neue Datei aus der Liste</div>';
                        currentDocument = null;
                    }, 2000);
                } else {
                    showStatus(`‚ùå ${workflowType}: Fehler - ${result.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showStatus(`‚ùå ${workflowType}: Fehler beim Verschieben`, 'error');
            });
        }

        function loadDirectoryStructureManual() {
            // Simplified version - just show the path input for now
            // Can be enhanced later with full directory browser
        }

        function toggleManualPathBrowser() {
            const list = document.getElementById('manual-directory-list');
            const icon = document.querySelector('#manual-path-browser .collapse-icon');

            if (list.style.display === 'none') {
                list.style.display = 'block';
                icon.textContent = '‚ñ≤';
            } else {
                list.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        function updatePathOnCategoryChange() {
            const categorySelect = document.getElementById('category-select');
            const pathInput = document.getElementById('suggested-path-input');

            if (categorySelect && pathInput && currentDocument) {
                const selectedCategory = categorySelect.value;
                const basePath = pathInput.value.split('/').slice(0, -1).join('/');
                const newPath = `${basePath}/${selectedCategory}`;
                pathInput.value = newPath;
                updateFinalSummary();
            }
        }

        // Enhanced updatePath function
        function updatePath() {
            updatePathOnCategoryChange();
            updateAvailablePaths();
            updateFinalSummary();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>

    <!-- System Metrics Footer -->
    <div class="system-metrics-footer" id="system-metrics-footer">
        <div class="metric">üìä CPU: <span id="cpu-usage">0%</span></div>
        <div class="metric">üíæ RAM: <span id="memory-usage">0%</span></div>
        <div class="metric">üíΩ Disk: <span id="disk-usage">0%</span></div>
        <div class="metric">üìÅ Cached: <span id="cached-files">0</span> files</div>
        <div class="metric">üîÑ LM Studio: <span id="lm-studio-status">‚óã</span></div>
    </div>
</body>
</html>
